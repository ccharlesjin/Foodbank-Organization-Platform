<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="/ProfileCss.css">
    <script src="https://unpkg.com/vue@3.2.31/dist/vue.global.prod.js"></script>
</head>
<body>
    <div id="app">
        <header>
            <div class="navbar">
                <div class="logo">FOODBANK AUSTRALIA</div>
                <nav>
                    <ul>
                        <li><a href="/index.html">Home</a></li>
                        <li><a href="/about.html">About</a></li>
                        <li><a href="/location.html">Location</a></li>
                        <li><a href="#" id="logout-button" @click="loadSection('logout')">Logout</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="sidebar">
            <h2>Dashboard</h2>
            <ul>
                <li><a href="#" @click="loadSection('info')">Personal Info</a></li>
                <li><a href="#">Organization Activities</a></li>
                <li><a href="/manager/members">Member Management</a></li>
                <li><a href="/manager/events">Events Management</a></li>
                <li><a href="/manager/updates">Post Updates</a></li>
                <li><a href="/manager/rsvp">RSVP Management</a></li>
            </ul>
        </div>

        <div class="content">
            <table class="activity-container">
                <thead>
                    <tr>
                        <th> </th>
                        <th>Activity Name</th>
                        <th>Date</th>
                        <th>Participants</th>
                        <th>Description</th>
                        <th>Join?</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><img src="/images/sydney.jpg" alt="Sydney Activities" class="activity-image"></td>
                        <td>Sydney Beach Cleanup</td>
                        <td>2024-05-15</td>
                        <td class="activity-participants">50 participants</td>
                        <td>Help clean up the Sydney beach area.</td>
                        <td><button type="button" class="activity-btn" style="background-color: green;">Join</button></td>
                    </tr>
                    <tr>
                        <td><img src="/images/melbourne.jpg" alt="Melbourne Activities" class="activity-image"></td>
                        <td>Melbourne Park Music Festival</td>
                        <td>2024-06-20</td>
                        <td class="activity-participants">200 participants</td>
                        <td>Enjoy live music in the park.</td>
                        <td><button type="button" class="activity-btn" style="background-color: green;">Join</button></td>
                    </tr>
                    <tr>
                        <td><img src="/images/adelaide.jpg" alt="Adelaide Activities" class="activity-image"></td>
                        <td>Adelaide Art Walk</td>
                        <td>2024-07-05</td>
                        <td class="activity-participants">80 participants</td>
                        <td>Explore street art around Adelaide.</td>
                        <td><button type="button" class="activity-btn" style="background-color: green;">Join</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div name="modal">
            <div id="editModal" class="modal-overlay" v-if="showEditModal">
                <div class="modal-container">
                    <div class="modal-header">
                        <h3>Edit Information</h3>
                        <button type="button" @click="showEditModal = false">X</button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="saveUserInfo">
                            <label for="username">Username:</label>
                            <input type="text" v-model="editUserInfo.user_name">
                            <label for="email">Email:</label>
                            <input type="text" v-model="editUserInfo.email">
                            <label for="fullname">Full Name:</label>
                            <input type="text" v-model="editUserInfo.full_name">
                            <label for="phone_number">Phone Number:</label>
                            <input type="text" v-model="editUserInfo.phone_number">
                            <button type="submit">Save</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div name="modal">
            <div id="changePasswordModal" class="modal-overlay" v-if="showChangePasswordModal">
                <div class="modal-container">
                    <div class="modal-header">
                        <h3>Change Password</h3>
                        <button type="button" @click="showChangePasswordModal = false">X</button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="saveNewPassword">
                            <label for="newPassword">New Password:</label>
                            <input type="password" v-model="newPassword">
                            <span id="passwordError" style="color: red;" v-if="passwordError">{{ passwordError }}</span>
                            <button type="submit">Save</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script>
        const app = Vue.createApp({
            data() {
                return {
                    managerBranchId: [],
                    manager: [],
                    branches: [],
                    userInfo: {
                        username: '',
                        email: '',
                        fullname: '',
                        phoneNumber: '',
                        organization: ''
                    },
                    editUserInfo: {
                        user_name: '',
                        email: '',
                        full_name: '',
                        phone_number: ''
                    },
                    showEditModal: false,
                    showChangePasswordModal: false,
                    avatar: '/1.jpg',
                    newPassword: '',
                    passwordError: '',
                    error: '',
                    currentSection: 'profile',
                };
            },
            methods: {
                fetchBranches() {
                    fetch('/api/branches', {
                        method: 'GET',
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Loaded branches:", data);
                        this.branches = data;
                    })
                    .catch(error => console.error('Error loading branches:', error));
                },
                fetchBranchId() {
                    fetch('/manager/api/branch_id')
                    .then(response => response.json())
                    .then(data => {
                        console.log("Got manager branch id:", data);
                        this.managerBranchId = data;
                    })
                    .catch(error => console.error('Error loading the managerBranchId:', error));
                },
                getBranchName(branchId) {
                    // Find the branch with the given ID and return its name
                    const branch = this.branches.find(branch => branch.branch_id === branchId);
                    return branch ? branch.branch_name : 'Unknown';  // Return 'Unknown' if no branch is found
                },
                fetchManagerInfo() {
                    fetch('/manager/api/manager_info', {
                        method: 'GET',
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Loaded manager:", data);
                        this.manager = data;
                    })
                    .catch(error => console.error('Error loading the manager-info:', error));
                },
                async saveUserInfo() {
                    console.log(this.editUserInfo);
                    try {
                        const managerUserId = this.manager[0].user_id;
                        const response = await fetch(`/manager/api/user/${managerUserId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.editUserInfo)
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        if (data.success) {
                            this.fetchManagerInfo();
                            this.showEditModal = false;
                        } else {
                            this.error = `Failed to save user info: ${data.message}`;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        this.error = `An error occurred while saving user info: ${error.message}`;
                    }
                },
                async saveNewPassword() {
                    if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[_])[A-Za-z\d_]{8,}$/.test(this.newPassword)) {
                        this.passwordError = "The password does not meet the requirements, please contain uppercase and lowercase letters, underscores and numbers, and at least 8 supplements";
                        return;
                    }
                    try {
                        const response = await fetch('/manager/api/User/changePassword', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ newPassword: this.newPassword })
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        if (data.success) {
                            alert('Password has been updated!');
                            this.showChangePasswordModal = false;
                        } else {
                            this.passwordError = `Failed to change password: ${data.message}`;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        this.passwordError = `An error occurred while changing password: ${error.message}`;
                    }
                },
                loadSection(section) {
                    console.log('load section!');
                    if (section === 'logout') {
                        // 发送请求到服务器端的logout路由
                        fetch('/manager/logout', { method: 'GET' })
                        .then(response => {
                            // 可以根据服务器响应处理逻辑
                            window.location.href = '/manager_login.html';  // 重定向到登录页面
                        })
                        .catch(error => {
                            console.error('Logout failed:', error);
                        });
                    } else if (section === 'info') {
                        window.location.href = '/manager/profile'; // Ensure this path is correct
                    } else if (section === this.currentSection) {
                        window.location.reload();
                    } else {
                        var xhr = new XMLHttpRequest();
                        xhr.open('GET', '/manager/' + section, true);
                        xhr.onreadystatechange = () => {
                            if (xhr.readyState === 4 && xhr.status === 200) {
                                document.querySelector('.content').innerHTML = xhr.responseText;
                                this.currentSection = section;
                                // 在内容加载后重新绑定 Vue.js 控制的事件
                                this.$nextTick(() => {
                                    console.log('Content loaded and Vue.js re-rendered');
                                });
                            }
                        };
                        xhr.send();
                    }
                },
                changePassword() {
                    this.showChangePasswordModal = true;
                    console.log('showChangePasswordModal:', this.showChangePasswordModal); // 调试模态框显示状态
                },
            },
            mounted() {
                this.fetchManagerInfo();
                this.fetchBranches();
                this.fetchBranchId();
            }
        });
        app.mount('#app');
    </script>
</body>
</html>
